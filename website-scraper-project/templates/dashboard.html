<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .bg-dark-custom {
            background-color: #1f2124 !important;
        }
        .btn-custom {
            background-color: #1f2124;
            color: white;
            border: none;
        }
        .btn-custom:hover {
            background-color: #333333;
        }
        .progress-bar-custom {
            background-color: #4CAF50;
        }
        .table-custom {
            background-color: #2a2d32;
            color: white;
        }
    </style>
</head>
<body class="bg-dark-custom">
    <div class="container py-5">
        <h1 class="text-center text-light mb-4">Task Dashboard</h1>
        <form method="post" enctype="multipart/form-data" class="d-flex justify-content-center mb-3">
            <input type="file" name="file" class="form-control" required>
            <button type="submit" class="btn btn-custom ms-2">Start Task</button>
        </form>
        <div class="table-responsive">
            <table class="table table-custom">
                <thead>
                    <tr>
                        <th>Task ID</th>
                        <th>Status</th>
                        <th>Progress</th>
                        <th>Start Time</th>
                        <th>Estimated Time Remaining</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tasks">
                    <!-- Task rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        async function updateTasks() {
            const response = await fetch('/tasks'); // Ensure the endpoint matches your Flask app's route
            const tasks = await response.json();
            const tasksContainer = document.getElementById('tasks');
            tasksContainer.innerHTML = ''; // Clear current tasks
            tasks.forEach(task => {
                const taskRow = `
                    <tr>
                        <td>${task.id}</td>
                        <td>${task.status}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated progress-bar-custom" style="width: ${task.progress}%;">${task.progress}%</div>
                            </div>
                        </td>
                        <td>${task.start_time || 'N/A'}</td>
                        <td>${task.estimated_time_remaining || 'Calculating...'}</td>
                        <td>
                            ${!task.done ? `<button onclick="cancelTask('${task.id}')" class="btn btn-danger">Cancel</button>` : ''}
                            ${task.done && task.results ? `<a href="/download/${task.id}" class="btn btn-success">Download Results</a>` : ''}
                        </td>
                    </tr>
                `;
                tasksContainer.innerHTML += taskRow;
            });
        }

        function cancelTask(taskId) {
            fetch(`/cancel/${taskId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log('Task cancelled:', data);
                    updateTasks(); // Refresh the task list
                })
                .catch(error => console.error('Error cancelling task:', error));
        }

        setInterval(updateTasks, 5000);  // Refresh task data every 5 seconds
        updateTasks();  // Initial call to load tasks
    </script>
</body>
</html>
